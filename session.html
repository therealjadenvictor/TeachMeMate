<!DOCTYPE html>
<html>
<head>
  <title>SkillSwap Call</title>

  <!-- Agora SDK -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      height: 100vh;
      display: flex;
    }

    #videoArea {
      flex: 3;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 10px;
      padding: 10px;
    }

    .videoBox {
      background: black;
      border-radius: 10px;
      overflow: hidden;
      height: 280px;
    }

    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
      border-left: 2px solid #333;
    }

    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    #controls {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #000;
    }

    button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .danger { background: #e53935; color: white; }
    .primary { background: #4caf50; color: white; }
    .secondary { background: #555; color: white; }

    input {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
    }
  </style>
</head>

<body>

  <div id="videoArea"></div>

  <div id="chatArea">
    <div id="messages"></div>

    <div style="display:flex; gap:5px; padding:10px;">
      <input id="chatInput" placeholder="Message..." />
      <button class="primary" onclick="sendMessage()">Send</button>
    </div>

    <div id="controls">
      <button class="secondary" onclick="toggleMic()">Mute</button>
      <button class="secondary" onclick="toggleCamera()">Camera Off</button>
      <button class="secondary" onclick="shareScreen()">Share Screen</button>
      <button class="danger" onclick="endCall()">End</button>
    </div>
  </div>

<script type="module">
  // ================= FIREBASE =================
  import { auth, db } from "./firebase-config.js";
  import {
    collection,
    addDoc,
    onSnapshot,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ================= AGORA =================
  const APP_ID = "30742989e5724819af083fe572732afa";
  const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

  let localTracks = [];
  let micOn = true;
  let camOn = true;
  let screenTrack = null;

  const params = new URLSearchParams(window.location.search);
  const room = params.get("room");

  await client.join(APP_ID, room, null, null);

  localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();

  const localDiv = document.createElement("div");
  localDiv.className = "videoBox";
  localDiv.id = "local";
  document.getElementById("videoArea").appendChild(localDiv);
  localTracks[1].play("local");

  await client.publish(localTracks);

  client.on("user-published", async (user, mediaType) => {
    await client.subscribe(user, mediaType);
    if (mediaType === "video") {
      const div = document.createElement("div");
      div.className = "videoBox";
      div.id = user.uid;
      document.getElementById("videoArea").appendChild(div);
      user.videoTrack.play(div);
    }
    if (mediaType === "audio") {
      user.audioTrack.play();
    }
  });

  client.on("user-unpublished", user => {
    document.getElementById(user.uid)?.remove();
  });

  // ================= CHAT =================
  const q = query(collection(db, "chats"), where("room", "==", room));

  onSnapshot(q, snap => {
    const messages = document.getElementById("messages");
    messages.innerHTML = "";
    snap.forEach(doc => {
      const p = document.createElement("p");
      p.textContent = doc.data().text;
      messages.appendChild(p);
    });
    messages.scrollTop = messages.scrollHeight;
  });

  window.sendMessage = async () => {
    const input = document.getElementById("chatInput");
    if (!input.value) return;

    await addDoc(collection(db, "chats"), {
      room,
      text: input.value,
      createdAt: serverTimestamp()
    });

    input.value = "";
  };

  // ================= CONTROLS =================
  window.toggleMic = () => {
    micOn = !micOn;
    localTracks[0].setEnabled(micOn);
  };

  window.toggleCamera = () => {
    camOn = !camOn;
    localTracks[1].setEnabled(camOn);
  };

  window.shareScreen = async () => {
    if (screenTrack) {
      await client.unpublish(screenTrack);
      screenTrack.close();
      screenTrack = null;
      await client.publish(localTracks[1]);
    } else {
      screenTrack = await AgoraRTC.createScreenVideoTrack();
      await client.unpublish(localTracks[1]);
      await client.publish(screenTrack);
    }
  };

  async function incrementSessionsTaken(uid) {
    try {
      const userRef = doc(db, "users", uid);
      const userSnap = await getDoc(userRef);
      const current = (userSnap.exists() && userSnap.data().sessionsTaken != null)
        ? Number(userSnap.data().sessionsTaken) : 0;
      await updateDoc(userRef, { sessionsTaken: current + 1 });
    } catch (err) {
      console.error("Failed to increment sessionsTaken for", uid, err);
    }
  }

  window.endCall = async () => {
    const me = auth.currentUser;
    const otherJoined = client.remoteUsers && client.remoteUsers.length > 0;

    localTracks.forEach(t => t.close());
    await client.leave();

    let otherUid = null;
    if (me && room) {
      try {
        const q = query(
          collection(db, "accepted_request"),
          where("code", "==", room)
        );
        const snap = await getDocs(q);
        if (!snap.empty) {
          const data = snap.docs[0].data();
          otherUid = data.senderId === me.uid ? data.receiverId : data.senderId;
          if (otherUid && otherJoined) {
            await incrementSessionsTaken(me.uid);
            await incrementSessionsTaken(otherUid);
          }
        }
      } catch (err) {
        console.error("Could not update sessions or resolve other user:", err);
      }
    }

    if (otherUid) {
      window.location.href = `review.html?uid=${encodeURIComponent(otherUid)}`;
      return;
    }
    window.location.href = "dashboard.html";
  };
</script>

</body>
</html>
