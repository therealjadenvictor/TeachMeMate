<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chats - TeachMeMate</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at 30% 20%, #111827, #020617);
      color: #e5e7eb;
      height: 100vh;
      display: flex;
    }

    .chat-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr;
      max-width: 1200px;
      margin: 1.5rem auto;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.98);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .chat-sidebar {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), transparent),
                  #020617;
      border-right: 1px solid rgba(148, 163, 184, 0.3);
      padding: 1.25rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chat-sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .chat-sidebar-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .chat-conversations {
      flex: 1;
      overflow-y: auto;
      margin-top: 0.5rem;
    }

    .chat-conversation-item {
      padding: 0.6rem 0.7rem;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      border: 1px solid transparent;
    }

    .chat-conversation-item:hover,
    .chat-conversation-item.active {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(56, 189, 248, 0.6);
    }

    .chat-conversation-name {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .chat-conversation-last {
      font-size: 0.8rem;
      color: #9ca3af;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-main {
      display: flex;
      flex-direction: column;
      padding: 1.25rem 1.5rem;
    }

    .chat-main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      padding-bottom: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .chat-main-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .chat-main-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .chat-message {
      max-width: 70%;
      padding: 0.45rem 0.7rem;
      border-radius: 10px;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .chat-message.me {
      align-self: flex-end;
      background: rgba(56, 189, 248, 0.2);
      border: 1px solid rgba(56, 189, 248, 0.6);
    }

    .chat-message.them {
      align-self: flex-start;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(75, 85, 99, 0.9);
    }

    .chat-input-bar {
      display: flex;
      gap: 0.6rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .chat-input-bar input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: #e5e7eb;
      padding: 0.55rem 0.9rem;
      font-size: 0.9rem;
    }

    .chat-input-bar button {
      border-radius: 999px;
      border: none;
      padding: 0.55rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22d3ee, #a855f7);
      color: #020617;
    }

    .chat-empty {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-top: 1rem;
    }

    @media (max-width: 900px) {
      .chat-layout {
        grid-template-columns: 1fr;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>

  <div class="chat-layout">
    <aside class="chat-sidebar">
      <div class="chat-sidebar-header">
        <div>
          <div class="chat-sidebar-title">Chats</div>
          <div style="font-size:0.78rem;color:#9ca3af;">Your recent conversations</div>
        </div>
        <button class="btn-ghost" type="button" onclick="window.location.href='dashboard.html'"
                style="border-radius:999px;border:1px solid rgba(148,163,184,0.6);background:transparent;color:#e5e7eb;font-size:0.75rem;padding:0.25rem 0.6rem;">
          ‚Üê Dashboard
        </button>
      </div>

      <div id="conversationList" class="chat-conversations">
        <div class="chat-empty" id="conversationEmpty">
          Start a chat from a user's profile to see it here.
        </div>
      </div>
    </aside>

    <main class="chat-main">
      <div class="chat-main-header">
        <div>
          <div class="chat-main-title" id="chatTitle">Select a conversation</div>
          <div class="chat-main-subtitle" id="chatSubtitle">Your messages will appear here.</div>
        </div>
      </div>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input-bar">
        <input id="chatInput" placeholder="Type a message..." autocomplete="off" />
        <button type="button" id="chatSend">Send</button>
      </div>
    </main>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      collection,
      addDoc,
      onSnapshot,
      query,
      where,
      serverTimestamp,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const roomParam = params.get('room');

    const conversationList = document.getElementById('conversationList');
    const conversationEmpty = document.getElementById('conversationEmpty');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatTitle = document.getElementById('chatTitle');
    const chatSubtitle = document.getElementById('chatSubtitle');

    let currentUser = null;
    let activeRoomId = null;
    let activeOtherUserId = null;

    function renderMessage(docData, isMe) {
      const div = document.createElement('div');
      div.className = 'chat-message ' + (isMe ? 'me' : 'them');
      div.textContent = docData.text || '';
      chatMessages.appendChild(div);
    }

    function subscribeToMessages(roomId) {
      chatMessages.innerHTML = '';

      const q = query(collection(db, "chats"), where("room", "==", roomId));
      onSnapshot(q, (snap) => {
        chatMessages.innerHTML = '';
        const items = [];
        snap.forEach(docSnap => {
          items.push({ id: docSnap.id, ...docSnap.data() });
        });

        // Sort by createdAt client-side to avoid composite index requirement
        items.sort((a, b) => {
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return ta - tb;
        });

        items.forEach(msg => {
          const isMe = msg.from === currentUser?.uid;
          renderMessage(msg, isMe);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    function bindSend(roomId) {
      async function send() {
        const text = (chatInput.value || '').trim();
        if (!text || !currentUser) return;

        try {
          await addDoc(collection(db, "chats"), {
            room: roomId,
            text,
            from: currentUser.uid,
            createdAt: serverTimestamp()
          });

          if (activeOtherUserId) {
            const convRef = doc(db, "conversations", roomId);
            await setDoc(convRef, {
              participants: [currentUser.uid, activeOtherUserId].sort(),
              lastMessage: text,
              lastUpdated: serverTimestamp()
            }, { merge: true });
          }

          chatInput.value = '';
        } catch (err) {
          console.error("Failed to send message", err);
        }
      }

      chatSend.onclick = send;
      chatInput.onkeydown = (e) => {
        if (e.key === 'Enter') send();
      };
    }

    function openConversation(roomId, otherUserId, otherUserName) {
      activeRoomId = roomId;
      activeOtherUserId = otherUserId || null;

      if (otherUserName) {
        chatTitle.textContent = `Chat with ${otherUserName}`;
        chatSubtitle.textContent = 'This conversation is stored securely in your account.';
      } else {
        chatTitle.textContent = 'Chat';
        chatSubtitle.textContent = 'Your messages are stored securely.';
      }

      subscribeToMessages(roomId);
      bindSend(roomId);
    }

    async function loadConversationList(user) {
      // Simple implementation: conversations are only created when coming from a user profile.
      // Here we just show a message; extending to full list is easy later.
      conversationEmpty.style.display = 'block';
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "signin.html";
        return;
      }

      currentUser = user;

      await loadConversationList(user);

      if (roomParam) {
        const roomId = roomParam;
        const parts = roomId.split('_');
        let otherUserId = null;

        if (parts.length === 2) {
          otherUserId = parts[0] === user.uid ? parts[1] : parts[0];
        }

        let otherUserName = null;
        if (otherUserId) {
          try {
            const otherRef = doc(db, "users", otherUserId);
            const otherSnap = await getDoc(otherRef);
            if (otherSnap.exists()) {
              const d = otherSnap.data();
              otherUserName = d.name || (d.email || '').split('@')[0] || 'User';
            }
          } catch (e) {
            console.error("Failed to load other user", e);
          }
        }

        openConversation(roomId, otherUserId, otherUserName);

        // Remember current conversation for dashboard chat preview
        localStorage.setItem('currentRoomId', roomId);
        if (otherUserId) {
          localStorage.setItem('currentRoomOtherUserId', otherUserId);
        }
        if (otherUserName) {
          localStorage.setItem('currentRoomName', otherUserName);
        }
      } else {
        chatMessages.innerHTML = '';
        chatTitle.textContent = "Your chats";
        chatSubtitle.textContent = "Open a chat from someone's profile to start talking.";
      }
    });
  </script>

</body>
</html>

