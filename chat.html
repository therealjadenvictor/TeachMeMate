<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chats - TeachMeMate</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <!-- Custom Theme -->
  <link rel="stylesheet" href="bootstrap-theme.css">
  
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
    }

    .chat-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr;
      max-width: 1200px;
      margin: 1.5rem auto;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.98);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .chat-sidebar {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), transparent),
                  #020617;
      border-right: 1px solid rgba(148, 163, 184, 0.3);
      padding: 1.25rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chat-conversations {
      flex: 1;
      overflow-y: auto;
      margin-top: 0.5rem;
    }

    .chat-conversation-item {
      padding: 0.6rem 0.7rem;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      border: 1px solid transparent;
      margin-bottom: 0.5rem;
    }

    .chat-conversation-item:hover,
    .chat-conversation-item.active {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(56, 189, 248, 0.6);
    }

    .chat-conversation-name {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .chat-conversation-last {
      font-size: 0.8rem;
      color: #9ca3af;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-main {
      display: flex;
      flex-direction: column;
      padding: 1.25rem 1.5rem;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      min-height: 400px;
      max-height: calc(100vh - 250px);
    }

    .chat-message {
      max-width: 70%;
      padding: 0.45rem 0.7rem;
      border-radius: 10px;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .chat-message.me {
      align-self: flex-end;
    }

    .chat-message.them {
      align-self: flex-start;
    }

    .chat-message.request-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem 1rem;
      min-width: 260px;
    }

    .chat-message.request-card .request-text {
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .chat-message.request-card .request-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .chat-message.request-card .request-actions .btn {
      cursor: pointer;
      padding: 0.4rem 1rem;
      font-weight: 500;
    }

    .chat-message.request-card .request-status {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    @media (max-width: 900px) {
      .chat-layout {
        grid-template-columns: 1fr;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>

  <div class="chat-layout">
    <aside class="chat-sidebar">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <div class="fw-semibold">Chats</div>
          <div class="small text-muted">Your recent conversations</div>
        </div>
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="window.location.href='dashboard.html'">
          ← Dashboard
        </button>
      </div>

      <div id="conversationList" class="chat-conversations">
        <div class="text-muted small" id="conversationEmpty">
          Start a chat from a user's profile to see it here.
        </div>
      </div>
    </aside>

    <main class="chat-main">
      <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom border-secondary">
        <div>
          <div class="fw-semibold" id="chatTitle">Select a conversation</div>
          <div class="small text-muted" id="chatSubtitle">Your messages will appear here.</div>
        </div>
      </div>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="d-flex gap-2 pt-3 border-top border-secondary">
        <input type="text" class="form-control rounded-pill" id="chatInput" placeholder="Type a message..." autocomplete="off" />
        <button class="btn btn-primary rounded-pill" type="button" id="chatSend">Send</button>
      </div>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      collection,
      addDoc,
      onSnapshot,
      query,
      where,
      serverTimestamp,
      doc,
      getDoc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const roomParam = params.get('room');

    const conversationList = document.getElementById('conversationList');
    const conversationEmpty = document.getElementById('conversationEmpty');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatTitle = document.getElementById('chatTitle');
    const chatSubtitle = document.getElementById('chatSubtitle');

    let currentUser = null;
    let activeRoomId = null;
    let activeOtherUserId = null;
    const userNameCache = new Map();

    function renderMessage(docData, isMe) {
  const div = document.createElement('div');
  div.className = 'chat-message ' + (isMe ? 'me' : 'them');

  if (docData.type === 'session_request') {
    div.classList.add('request-card');

    const textEl = document.createElement('div');
    textEl.className = 'request-text';
    textEl.textContent = docData.text || 'Session request';
    div.appendChild(textEl);

    const status = docData.status || 'pending';
    const requestId = docData.id || docData.requestId;

    // Receiver → Accept/Reject buttons
    if (!isMe && status === 'pending') {
      const actions = document.createElement('div');
      actions.className = 'request-actions';

      const acceptBtn = document.createElement('button');
      acceptBtn.className = 'btn btn-success';
      acceptBtn.textContent = 'Accept';

      const rejectBtn = document.createElement('button');
      rejectBtn.className = 'btn btn-outline-danger';
      rejectBtn.textContent = 'Reject';

      if (requestId) {
        acceptBtn.onclick = () =>
          updateDoc(doc(db, 'chats', requestId), { status: 'accepted' });

        rejectBtn.onclick = () =>
          updateDoc(doc(db, 'chats', requestId), { status: 'rejected' });
      }

      actions.appendChild(acceptBtn);
      actions.appendChild(rejectBtn);
      div.appendChild(actions);
    }

    // Sender → Pending indicator
    if (isMe && status === 'pending') {
      const pendingEl = document.createElement('div');
      pendingEl.className = 'request-status text-info fw-semibold';
      pendingEl.textContent = '⏳ Pending request';
      div.appendChild(pendingEl);
    }

    // Final status for both users
    if (status === 'accepted') {
      const statusEl = document.createElement('div');
      statusEl.className = 'request-status text-success fw-semibold';
      statusEl.textContent = '✓ Accepted';
      div.appendChild(statusEl);
    }

    if (status === 'rejected') {
      const statusEl = document.createElement('div');
      statusEl.className = 'request-status text-danger fw-semibold';
      statusEl.textContent = '✗ Rejected';
      div.appendChild(statusEl);
    }

  } else {
    div.textContent = docData.text || '';
  }

  chatMessages.appendChild(div);
}


    function subscribeToMessages(roomId) {
      chatMessages.innerHTML = '';

      const q = query(collection(db, "chats"), where("room", "==", roomId));
      onSnapshot(q, (snap) => {
        chatMessages.innerHTML = '';
        const items = [];
        snap.forEach(docSnap => {
          items.push({ id: docSnap.id, ...docSnap.data() });
        });

        items.sort((a, b) => {
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return ta - tb;
        });

        items.forEach(msg => {
          const isMe = msg.from === currentUser?.uid;
          renderMessage(msg, isMe);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    function bindSend(roomId) {
      async function send() {
        const text = (chatInput.value || '').trim();
        if (!text || !currentUser) return;

        try {
          await addDoc(collection(db, "chats"), {
            room: roomId,
            text,
            from: currentUser.uid,
            createdAt: serverTimestamp()
          });

          if (activeOtherUserId) {
            const convRef = doc(db, "conversations", roomId);
            await setDoc(convRef, {
              participants: [currentUser.uid, activeOtherUserId].sort(),
              lastMessage: text,
              lastUpdated: serverTimestamp()
            }, { merge: true });
          }

          chatInput.value = '';
        } catch (err) {
          console.error("Failed to send message", err);
        }
      }

      chatSend.onclick = send;
      chatInput.onkeydown = (e) => {
        if (e.key === 'Enter') send();
      };
    }

    function openConversation(roomId, otherUserId, otherUserName) {
      activeRoomId = roomId;
      activeOtherUserId = otherUserId || null;

      if (otherUserName) {
        chatTitle.textContent = `Chat with ${otherUserName}`;
        chatSubtitle.textContent = 'This conversation is stored securely in your account.';
      } else {
        chatTitle.textContent = 'Chat';
        chatSubtitle.textContent = 'Your messages are stored securely.';
      }

      subscribeToMessages(roomId);
      bindSend(roomId);
    }

    async function loadConversationList(user) {
      const convQuery = query(
        collection(db, "conversations"),
        where("participants", "array-contains", user.uid)
      );

      onSnapshot(convQuery, async (snap) => {
        const items = [];
        snap.forEach(docSnap => {
          items.push({ id: docSnap.id, ...docSnap.data() });
        });

        items.sort((a, b) => {
          const ta = a.lastUpdated?.seconds || 0;
          const tb = b.lastUpdated?.seconds || 0;
          return tb - ta;
        });

        conversationList.innerHTML = '';

        if (!items.length) {
          conversationEmpty.style.display = 'block';
          return;
        }

        conversationEmpty.style.display = 'none';

        for (const conv of items) {
          const otherId =
            Array.isArray(conv.participants) && conv.participants.length === 2
              ? (conv.participants[0] === user.uid
                  ? conv.participants[1]
                  : conv.participants[0])
              : null;

          let otherName = 'User';
          if (otherId) {
            if (userNameCache.has(otherId)) {
              otherName = userNameCache.get(otherId);
            } else {
              try {
                const otherRef = doc(db, "users", otherId);
                const otherSnap = await getDoc(otherRef);
                if (otherSnap.exists()) {
                  const d = otherSnap.data();
                  otherName = d.name || (d.email || '').split('@')[0] || 'User';
                  userNameCache.set(otherId, otherName);
                }
              } catch (e) {
                console.error("Failed to load other user for conversation list", e);
              }
            }
          }

          const item = document.createElement('div');
          item.className = 'chat-conversation-item' + (conv.id === activeRoomId ? ' active' : '');

          const nameEl = document.createElement('div');
          nameEl.className = 'chat-conversation-name';
          nameEl.textContent = otherName;

          const lastEl = document.createElement('div');
          lastEl.className = 'chat-conversation-last';
          lastEl.textContent = conv.lastMessage || 'No messages yet';

          item.appendChild(nameEl);
          item.appendChild(lastEl);

          item.addEventListener('click', () => {
            openConversation(conv.id, otherId, otherName);
            localStorage.setItem('currentRoomId', conv.id);
            if (otherId) {
              localStorage.setItem('currentRoomOtherUserId', otherId);
            }
            if (otherName) {
              localStorage.setItem('currentRoomName', otherName);
            }
            const url = new URL(window.location.href);
            url.searchParams.set('room', conv.id);
            window.history.replaceState(null, '', url.toString());
          });

          conversationList.appendChild(item);
        }
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "signin.html";
        return;
      }

      currentUser = user;

      await loadConversationList(user);

      if (roomParam) {
        const roomId = roomParam;
        const parts = roomId.split('_');
        let otherUserId = null;

        if (parts.length === 2) {
          otherUserId = parts[0] === user.uid ? parts[1] : parts[0];
        }

        let otherUserName = null;
        if (otherUserId) {
          try {
            const otherRef = doc(db, "users", otherUserId);
            const otherSnap = await getDoc(otherRef);
            if (otherSnap.exists()) {
              const d = otherSnap.data();
              otherUserName = d.name || (d.email || '').split('@')[0] || 'User';
            }
          } catch (e) {
            console.error("Failed to load other user", e);
          }
        }

        openConversation(roomId, otherUserId, otherUserName);

        localStorage.setItem('currentRoomId', roomId);
        if (otherUserId) {
          localStorage.setItem('currentRoomOtherUserId', otherUserId);
        }
        if (otherUserName) {
          localStorage.setItem('currentRoomName', otherUserName);
        }
      } else {
        chatMessages.innerHTML = '';
        chatTitle.textContent = "Your chats";
        chatSubtitle.textContent = "Open a chat from someone's profile to start talking.";
      }
    });
  </script>

</body>
</html>
