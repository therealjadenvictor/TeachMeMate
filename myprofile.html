<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile - TMate</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#070b18;
  --sidebar:#0e1428;
  --card:#1e2545;
  --accent:#00d4ff;
  --text:#d6e1ff;
}

*{box-sizing:border-box;margin:0;padding:0;}

body{
  font-family:'Poppins',sans-serif;
  background:radial-gradient(circle at 30% 20%,#18204a,var(--bg));
  color:var(--text);
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  left:0;
  top:0;
  width:240px;
  height:100vh;
  background:linear-gradient(180deg,#0e1428,#0b1020);
  border-right:1px solid #1f284f;
  padding:2rem 0;
}

.sidebar h2{
  color:#6fa8ff;
  text-align:center;
  margin-bottom:2.5rem;
  letter-spacing:2px;
}

.sidebar-menu{
  list-style:none;
}

.sidebar-menu a{
  display:flex;
  align-items:center;
  gap:10px;
  padding:1rem 1.5rem;
  color:#9fb3ff;
  text-decoration:none;
  border-left:4px solid transparent;
}

.sidebar-menu a.active,
.sidebar-menu a:hover{
  background:rgba(0,212,255,0.08);
  color:var(--accent);
  border-left-color:var(--accent);
}

/* MAIN */
.main{
  margin-left:240px;
  padding:3rem 4rem;
}

h1{
  color:var(--accent);
  margin-bottom:2rem;
}

.cards{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:1.5rem;
  margin-bottom:3rem;
}

.card{
  background:var(--card);
  padding:2rem;
  border-radius:16px;
  text-align:center;
}

.profile-details{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:1.5rem;
}

.detail{
  background:var(--card);
  padding:1.5rem;
  border-radius:12px;
}

.detail span{
  color:#9fb3ff;
  font-size:0.85rem;
}

.value{
  font-size:1.1rem;
  margin-top:6px;
}

input,select,textarea{
  width:100%;
  margin-top:6px;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#141a33;
  color:white;
}

button{
  margin-top:2rem;
  padding:0.8rem 1.8rem;
  background:var(--accent);
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

.hidden{display:none;}
</style>
</head>

<body>

<div class="sidebar">
<h2>TMate</h2>
<ul class="sidebar-menu">
  <li><a href="dashboard.html">üìä Dashboard</a></li>
  <li><a href="chat.html">üí¨ All Chats</a></li>
  <li><a href="#">üéì My Sessions</a></li>
  <li><a href="#">üë®‚Äçüè´ Teaching</a></li>
</ul>
</div>

<div class="main">
<h1>My Profile</h1>

<div class="cards">
<div class="card"><h2 id="ratingDisplay">‚≠ê 0.0</h2>Rating</div>
<div class="card"><h2 id="sessionsTakenDisplay">0</h2>Sessions Taken</div>
<div class="card"><h2 id="sessionsGivenDisplay">0</h2>Sessions Given</div>
<div class="card"><h2>18 Feb</h2>Next Session</div>
</div>

<!-- VIEW MODE -->
<div id="viewMode">
<div class="profile-details">
<div class="detail"><span>Name</span><div class="value" id="vName">Loading...</div></div>
<div class="detail"><span>Email</span><div class="value" id="vEmail">Loading...</div></div>
<div class="detail"><span>Age</span><div class="value" id="vAge">-</div></div>
<div class="detail"><span>Gender</span><div class="value" id="vGender">-</div></div>
<div class="detail"><span>My Skills</span><div class="value" id="vSkills">-</div></div>
<div class="detail"><span>Skills I Want to Learn</span><div class="value" id="vTeachSkills">-</div></div>
</div>
<button onclick="editProfile()">Edit Profile</button>
</div>

<!-- EDIT MODE -->
<div id="editMode" class="hidden">
<div class="profile-details">
<div class="detail"><span>Name</span><input id="name"></div>
<div class="detail"><span>Email</span><input id="email" type="email"></div>

<div class="detail">
<span>Age: <b id="ageVal">21</b></span>
<input type="range" min="18" max="100" value="21" id="age" oninput="ageVal.textContent=this.value">
</div>

<div class="detail"><span>Gender</span>
<select id="gender"><option>Male</option><option>Female</option><option>Other</option></select>
</div>

<div class="detail"><span>My Skills</span><textarea id="skills"></textarea></div>
<div class="detail"><span>Skills I Want to Learn</span><textarea id="teachSkills"></textarea></div>
</div>
<button onclick="saveProfile()">Save</button>
<button onclick="cancelEdit()">Cancel</button>
</div>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const viewMode = document.getElementById('viewMode');
const editMode = document.getElementById('editMode');

const vName = document.getElementById('vName');
const vEmail = document.getElementById('vEmail');
const vAge = document.getElementById('vAge');
const vGender = document.getElementById('vGender');
const vSkills = document.getElementById('vSkills');
const vTeachSkills = document.getElementById('vTeachSkills');

const ratingDisplay = document.getElementById('ratingDisplay');
const sessionsTakenDisplay = document.getElementById('sessionsTakenDisplay');
const sessionsGivenDisplay = document.getElementById('sessionsGivenDisplay');

const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const ageInput = document.getElementById('age');
const ageVal = document.getElementById('ageVal');
const genderSelect = document.getElementById('gender');
const skillsInput = document.getElementById('skills');
const teachSkillsInput = document.getElementById('teachSkills');

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    // Not logged in ‚Üí go to sign in
    window.location.href = "signin.html";
    return;
  }

  currentUser = user;

  try {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    if (snap.exists()) {
      const data = snap.data();

      vName.textContent = data.name || user.email.split("@")[0];
      vEmail.textContent = data.email || user.email;
      vAge.textContent = data.age != null ? data.age : "-";
      vGender.textContent = data.gender || "-";

      const skillsArray = Array.isArray(data.skills)
        ? data.skills
        : (data.teach ? String(data.teach).split(",") : []);
      const skillsText = skillsArray
        .map(s => s.trim())
        .filter(Boolean)
        .join(", ");

      vSkills.textContent = skillsText || "-";
      vTeachSkills.textContent = data.learn || "-";

      // Display stats with defaults
      const rating = data.rating != null ? data.rating : 0;
      const sessionsTaken = data.sessionsTaken != null ? data.sessionsTaken : 0;
      const sessionsGiven = data.sessionsGiven != null ? data.sessionsGiven : 0;

      ratingDisplay.textContent = `‚≠ê ${rating.toFixed(1)}`;
      sessionsTakenDisplay.textContent = sessionsTaken;
      sessionsGivenDisplay.textContent = sessionsGiven;
    } else {
      // No profile yet ‚Üí basic defaults from auth
      vName.textContent = user.email.split("@")[0];
      vEmail.textContent = user.email;
      vAge.textContent = "-";
      vGender.textContent = "-";
      vSkills.textContent = "-";
      vTeachSkills.textContent = "-";

      // Default stats
      ratingDisplay.textContent = "‚≠ê 0.0";
      sessionsTakenDisplay.textContent = "0";
      sessionsGivenDisplay.textContent = "0";
    }
  } catch (err) {
    console.error("Failed to load profile", err);
  }
});

function editProfile(){
  viewMode.classList.add('hidden');
  editMode.classList.remove('hidden');

  nameInput.value = vName.textContent === "Loading..." ? "" : vName.textContent;
  emailInput.value = vEmail.textContent === "Loading..." ? "" : vEmail.textContent;
  ageInput.value = (vAge.textContent && vAge.textContent !== "-" ? vAge.textContent : "21");
  ageVal.textContent = ageInput.value;
  genderSelect.value = (vGender.textContent && vGender.textContent !== "-" ? vGender.textContent : "Male");
  skillsInput.value = vSkills.textContent === "-" ? "" : vSkills.textContent;
  teachSkillsInput.value = vTeachSkills.textContent === "-" ? "" : vTeachSkills.textContent;
}

async function saveProfile(){
  if (!currentUser) {
    alert("You must be logged in to save your profile.");
    return;
  }

  const nameValue = nameInput.value.trim();
  const emailValue = emailInput.value.trim() || currentUser.email;
  const ageValue = parseInt(ageInput.value, 10);
  const genderValue = genderSelect.value;
  const skillsRaw = skillsInput.value;
  const learnSkillsRaw = teachSkillsInput.value;

  const skillsArray = skillsRaw
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);

  const skillsNormalized = skillsArray.map(s => s.toLowerCase());

  const payload = {
    name: nameValue || emailValue.split("@")[0],
    email: emailValue,
    age: isNaN(ageValue) ? null : ageValue,
    gender: genderValue,
    skills: skillsArray,
    skills_normalized: skillsNormalized,
    learn: learnSkillsRaw
  };

  try {
    const ref = doc(db, "users", currentUser.uid);
    
    // Get existing data to preserve stats
    const existingSnap = await getDoc(ref);
    const existingData = existingSnap.exists() ? existingData : {};
    
    const finalPayload = {
      ...payload,
      rating: existingData.rating != null ? existingData.rating : 0,
      sessionsTaken: existingData.sessionsTaken != null ? existingData.sessionsTaken : 0,
      sessionsGiven: existingData.sessionsGiven != null ? existingData.sessionsGiven : 0
    };
    
    await setDoc(ref, finalPayload, { merge: true });

    vName.textContent = payload.name;
    vEmail.textContent = payload.email;
    vAge.textContent = payload.age != null ? payload.age : "-";
    vGender.textContent = payload.gender || "-";
    vSkills.textContent = skillsArray.length ? skillsArray.join(", ") : "-";
    vTeachSkills.textContent = payload.learn || "-";

    ratingDisplay.textContent = `‚≠ê ${finalPayload.rating.toFixed(1)}`;
    sessionsTakenDisplay.textContent = finalPayload.sessionsTaken;
    sessionsGivenDisplay.textContent = finalPayload.sessionsGiven;

    cancelEdit();
  } catch (err) {
    console.error("Failed to save profile", err);
    alert("Could not save profile. Please try again.");
  }
}

function cancelEdit(){
  editMode.classList.add('hidden');
  viewMode.classList.remove('hidden');
}

window.editProfile = editProfile;
window.saveProfile = saveProfile;
window.cancelEdit = cancelEdit;
</script>

</body>
</html>

