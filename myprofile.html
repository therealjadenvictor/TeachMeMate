<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile - TMate</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
<!-- Custom Theme -->
<link rel="stylesheet" href="bootstrap-theme.css">

<style>
body {
  min-height: 100vh;
}

.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 240px;
  height: 100vh;
  overflow-y: auto;
  z-index: 1000;
}

.main {
  margin-left: 240px;
  min-height: 100vh;
}

@media (max-width: 991px) {
  .sidebar {
    position: relative;
    width: 100%;
    height: auto;
  }
  
  .main {
    margin-left: 0;
  }
}
</style>
</head>

<body>

<div class="d-flex">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="p-3 mb-3">
      <h4 class="text-center mb-0 text-primary">TMate</h4>
    </div>

    <nav class="nav flex-column px-2">
      <a class="nav-link" href="dashboard.html">
        <i class="bi bi-speedometer2 me-2"></i> Dashboard
      </a>
      <a class="nav-link" href="chat.html">
        <i class="bi bi-chat-dots me-2"></i> All Chats
      </a>
      <a class="nav-link" href="#">
        <i class="bi bi-book me-2"></i> My Sessions
      </a>
      <a class="nav-link" href="#">
        <i class="bi bi-person-workspace me-2"></i> Teaching
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main flex-grow-1 p-4">
    <div class="container-fluid">
      <h1 class="text-primary mb-4">My Profile</h1>

      <!-- Stats Cards -->
      <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6">
          <div class="card text-center p-3">
            <h2 class="text-primary mb-2" id="ratingDisplay">⭐ 0.0</h2>
            <p class="text-muted mb-0">Rating</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card text-center p-3">
            <h2 class="text-primary mb-2" id="sessionsTakenDisplay">0</h2>
            <p class="text-muted mb-0">Sessions Taken</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card text-center p-3">
            <h2 class="text-primary mb-2" id="sessionsGivenDisplay">0</h2>
            <p class="text-muted mb-0">Sessions Given</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card text-center p-3">
            <h2 class="text-primary mb-2">18 Feb</h2>
            <p class="text-muted mb-0">Next Session</p>
          </div>
        </div>
      </div>

      <!-- VIEW MODE -->
      <div id="viewMode">
        <div class="row g-3 mb-4">
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <span class="text-muted small">Name</span>
              <div class="value mt-2" id="vName">Loading...</div>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <span class="text-muted small">Email</span>
              <div class="value mt-2" id="vEmail">Loading...</div>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <span class="text-muted small">Age</span>
              <div class="value mt-2" id="vAge">-</div>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <span class="text-muted small">Gender</span>
              <div class="value mt-2" id="vGender">-</div>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <span class="text-muted small">My Skills</span>
              <div class="value mt-2" id="vSkills">-</div>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <span class="text-muted small">Skills I Want to Learn</span>
              <div class="value mt-2" id="vTeachSkills">-</div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="editProfile()">Edit Profile</button>
      </div>

      <!-- EDIT MODE -->
      <div id="editMode" class="d-none">
        <div class="row g-3 mb-4">
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <label class="form-label text-muted small">Name</label>
              <input type="text" class="form-control" id="name">
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <label class="form-label text-muted small">Email</label>
              <input type="email" class="form-control" id="email">
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <label class="form-label text-muted small">Age: <b id="ageVal">21</b></label>
              <input type="range" class="form-range" min="18" max="100" value="21" id="age" oninput="ageVal.textContent=this.value">
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card p-3">
              <label class="form-label text-muted small">Gender</label>
              <select class="form-select" id="gender">
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <label class="form-label text-muted small">My Skills</label>
              <textarea class="form-control" id="skills" rows="3"></textarea>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <label class="form-label text-muted small">Skills I Want to Learn</label>
              <textarea class="form-control" id="teachSkills" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" onclick="saveProfile()">Save</button>
          <button class="btn btn-outline-secondary" onclick="cancelEdit()">Cancel</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const viewMode = document.getElementById('viewMode');
const editMode = document.getElementById('editMode');

const vName = document.getElementById('vName');
const vEmail = document.getElementById('vEmail');
const vAge = document.getElementById('vAge');
const vGender = document.getElementById('vGender');
const vSkills = document.getElementById('vSkills');
const vTeachSkills = document.getElementById('vTeachSkills');

const ratingDisplay = document.getElementById('ratingDisplay');
const sessionsTakenDisplay = document.getElementById('sessionsTakenDisplay');
const sessionsGivenDisplay = document.getElementById('sessionsGivenDisplay');

const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const ageInput = document.getElementById('age');
const ageVal = document.getElementById('ageVal');
const genderSelect = document.getElementById('gender');
const skillsInput = document.getElementById('skills');
const teachSkillsInput = document.getElementById('teachSkills');

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "signin.html";
    return;
  }

  currentUser = user;

  try {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    if (snap.exists()) {
      const data = snap.data();

      vName.textContent = data.name || user.email.split("@")[0];
      vEmail.textContent = data.email || user.email;
      vAge.textContent = data.age != null ? data.age : "-";
      vGender.textContent = data.gender || "-";

      const skillsArray = Array.isArray(data.skills)
        ? data.skills
        : (data.teach ? String(data.teach).split(",") : []);
      const skillsText = skillsArray
        .map(s => s.trim())
        .filter(Boolean)
        .join(", ");

      vSkills.textContent = skillsText || "-";
      vTeachSkills.textContent = data.learn || "-";

      const rating = data.rating != null ? data.rating : 0;
      const sessionsTaken = data.sessionsTaken != null ? data.sessionsTaken : 0;
      const sessionsGiven = data.sessionsGiven != null ? data.sessionsGiven : 0;

      ratingDisplay.textContent = `⭐ ${rating.toFixed(1)}`;
      sessionsTakenDisplay.textContent = sessionsTaken;
      sessionsGivenDisplay.textContent = sessionsGiven;
    } else {
      vName.textContent = user.email.split("@")[0];
      vEmail.textContent = user.email;
      vAge.textContent = "-";
      vGender.textContent = "-";
      vSkills.textContent = "-";
      vTeachSkills.textContent = "-";

      ratingDisplay.textContent = "⭐ 0.0";
      sessionsTakenDisplay.textContent = "0";
      sessionsGivenDisplay.textContent = "0";
    }
  } catch (err) {
    console.error("Failed to load profile", err);
  }
});

function editProfile(){
  viewMode.classList.add('d-none');
  editMode.classList.remove('d-none');

  nameInput.value = vName.textContent === "Loading..." ? "" : vName.textContent;
  emailInput.value = vEmail.textContent === "Loading..." ? "" : vEmail.textContent;
  ageInput.value = (vAge.textContent && vAge.textContent !== "-" ? vAge.textContent : "21");
  ageVal.textContent = ageInput.value;
  genderSelect.value = (vGender.textContent && vGender.textContent !== "-" ? vGender.textContent : "Male");
  skillsInput.value = vSkills.textContent === "-" ? "" : vSkills.textContent;
  teachSkillsInput.value = vTeachSkills.textContent === "-" ? "" : vTeachSkills.textContent;
}

async function saveProfile(){
  if (!currentUser) {
    alert("You must be logged in to save your profile.");
    return;
  }

  const nameValue = nameInput.value.trim();
  const emailValue = emailInput.value.trim() || currentUser.email;
  const ageValue = parseInt(ageInput.value, 10);
  const genderValue = genderSelect.value;
  const skillsRaw = skillsInput.value;
  const learnSkillsRaw = teachSkillsInput.value;

  const skillsArray = skillsRaw
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);

  const skillsNormalized = skillsArray.map(s => s.toLowerCase());

  const payload = {
    name: nameValue || emailValue.split("@")[0],
    email: emailValue,
    age: isNaN(ageValue) ? null : ageValue,
    gender: genderValue,
    skills: skillsArray,
    skills_normalized: skillsNormalized,
    learn: learnSkillsRaw
  };

  try {
    const ref = doc(db, "users", currentUser.uid);
    
    const existingSnap = await getDoc(ref);
    const existingData = existingSnap.exists() ? existingSnap.data() : {};
    
    const finalPayload = {
      ...payload,
      rating: existingData.rating != null ? existingData.rating : 0,
      sessionsTaken: existingData.sessionsTaken != null ? existingData.sessionsTaken : 0,
      sessionsGiven: existingData.sessionsGiven != null ? existingData.sessionsGiven : 0
    };
    
    await setDoc(ref, finalPayload, { merge: true });

    vName.textContent = payload.name;
    vEmail.textContent = payload.email;
    vAge.textContent = payload.age != null ? payload.age : "-";
    vGender.textContent = payload.gender || "-";
    vSkills.textContent = skillsArray.length ? skillsArray.join(", ") : "-";
    vTeachSkills.textContent = payload.learn || "-";

    ratingDisplay.textContent = `⭐ ${finalPayload.rating.toFixed(1)}`;
    sessionsTakenDisplay.textContent = finalPayload.sessionsTaken;
    sessionsGivenDisplay.textContent = finalPayload.sessionsGiven;

    cancelEdit();
  } catch (err) {
    console.error("Failed to save profile", err);
    alert("Could not save profile. Please try again.");
  }
}

function cancelEdit(){
  editMode.classList.add('d-none');
  viewMode.classList.remove('d-none');
}

window.editProfile = editProfile;
window.saveProfile = saveProfile;
window.cancelEdit = cancelEdit;
</script>

</body>
</html>
