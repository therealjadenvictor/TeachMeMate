<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="UTF-8" />
  <title>Recommendations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <link rel="stylesheet" href="transitions.css">
  <style>
    body {
      min-height: 100vh;
      background: #020617;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated gradient orbs - same theme colors */
    .bg-orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.4;
      pointer-events: none;
      z-index: 0;
    }

    .bg-orb-1 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.5) 0%, transparent 70%);
      top: -100px;
      right: -100px;
      animation: float 12s ease-in-out infinite;
    }

    .bg-orb-2 {
      width: 350px;
      height: 350px;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.45) 0%, transparent 70%);
      bottom: -80px;
      left: -80px;
      animation: float 14s ease-in-out infinite reverse;
      animation-delay: -3s;
    }

    .bg-orb-3 {
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, rgba(34, 211, 238, 0.35) 0%, transparent 70%);
      top: 50%;
      left: 30%;
      animation: float 10s ease-in-out infinite;
      animation-delay: -5s;
    }

    @keyframes float {

      0%,
      100% {
        transform: translate(0, 0) scale(1);
      }

      33% {
        transform: translate(20px, -20px) scale(1.05);
      }

      66% {
        transform: translate(-15px, 15px) scale(0.98);
      }
    }

    .content-wrap {
      position: relative;
      z-index: 1;
      padding: 2rem 0;
    }

    .rounded-box {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 24px;
      padding: 2rem 2.5rem;
      max-width: 1200px;
      margin: 0 auto;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35),
        0 0 0 1px rgba(148, 163, 184, 0.08);
    }

    .page-title {
      font-size: 2.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(120deg, #38bdf8 0%, #22d3ee 25%, #818cf8 50%, #a78bfa 75%, #38bdf8 100%);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-shift 3s ease infinite, glow-pulse 2.5s ease-in-out infinite;
    }

    @keyframes gradient-shift {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes glow-pulse {

      0%,
      100% {
        filter: drop-shadow(0 0 20px rgba(56, 189, 248, 0.7)) drop-shadow(0 0 40px rgba(56, 189, 248, 0.4));
      }

      50% {
        filter: drop-shadow(0 0 28px rgba(129, 140, 248, 0.8)) drop-shadow(0 0 56px rgba(167, 139, 250, 0.5));
      }
    }

    .rec-card {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      overflow: hidden;
      transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1),
        box-shadow 0.35s ease,
        border-color 0.3s ease;
    }

    .rec-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4),
        0 0 40px rgba(56, 189, 248, 0.15),
        0 0 80px rgba(129, 140, 248, 0.1);
      border-color: rgba(56, 189, 248, 0.4);
    }

    .rec-card .card-body {
      padding: 1.5rem;
    }

    .rec-card .card-title {
      font-weight: 600;
      color: #e2e8f0;
    }

    .rec-card .btn-outline-primary {
      border-radius: 999px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .rec-card .btn-outline-primary:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
    }

    .rec-card.stimulate-in {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
      animation: cardIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes cardIn {
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .back-btn {
      border-radius: 999px;
      font-weight: 500;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .back-btn:hover {
      transform: translateX(-4px);
      box-shadow: 0 4px 20px rgba(148, 163, 184, 0.2);
    }

    .rec-card .small,
    .rec-card p {
      font-size: 1.05rem !important;
      line-height: 1.5;
    }

    #emptyState {
      color: #94a3b8;
      font-size: 1.1rem;
      line-height: 1.6;
    }
  </style>
</head>

<body class="p-4">
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="bg-orb bg-orb-3"></div>

  <div class="container content-wrap">
    <div class="rounded-box">
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h2 class="mb-0 page-title">Recommended for You</h2>
        <a href="dashboard.html" class="btn btn-outline-secondary back-btn">
          <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>

      <div id="recommendations" class="row g-3"></div>

      <p id="emptyState" class="text-muted mt-3 d-none">
        No recommendations yet. Add learning interests to your profile.
      </p>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import {
      collection,
      getDocs,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const container = document.getElementById("recommendations");
    const emptyState = document.getElementById("emptyState");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "signin.html";
        return;
      }

      const meSnap = await getDoc(doc(db, "users", user.uid));
      if (!meSnap.exists()) {
        emptyState.classList.remove("d-none");
        emptyState.textContent = "No profile found. Please complete your profile first.";
        return;
      }

      const myData = meSnap.data();

      // Get learning interests - try learn_normalized first, fallback to parsing learn field
      let myLearn = myData.learn_normalized || [];

      // If learn_normalized doesn't exist but learn does, parse it
      if (!Array.isArray(myLearn) || myLearn.length === 0) {
        if (myData.learn) {
          myLearn = String(myData.learn)
            .split(",")
            .map(s => s.trim().toLowerCase())
            .filter(Boolean);
        }
      }

      console.log("My learning interests:", myLearn);

      if (!myLearn.length) {
        emptyState.classList.remove("d-none");
        emptyState.textContent = "No learning interests found. Please add skills you want to learn in your profile.";
        return;
      }

      // Get all learning interests from the logged-in user's profile
      const learningInterests = Array.isArray(myLearn) ? myLearn : [];

      const allUsers = await getDocs(collection(db, "users"));

      let found = false;
      container.innerHTML = "";

      console.log("Total users found:", allUsers.size);
      console.log("Looking for users who can teach:", learningInterests);

      allUsers.forEach((docSnap) => {
        // Exclude the logged-in user
        if (docSnap.id === user.uid) return;

        const data = docSnap.data();

        // Get skills - try skills_normalized first, fallback to parsing skills/teach field
        let skills = data.skills_normalized || [];
        if (!Array.isArray(skills) || skills.length === 0) {
          if (data.skills && Array.isArray(data.skills)) {
            skills = data.skills.map(s => String(s).toLowerCase().trim());
          } else if (data.teach) {
            skills = String(data.teach)
              .split(",")
              .map(s => s.trim().toLowerCase())
              .filter(Boolean);
          }
        }

        const skillsDisplay = Array.isArray(data.skills) ? data.skills :
          (data.teach ? String(data.teach).split(",").map(s => s.trim()).filter(Boolean) : []);

        if (!Array.isArray(skills) || skills.length === 0) return;

        console.log(`Checking user ${data.name || docSnap.id}:`, {
          skills_normalized: skills,
          learningInterests: learningInterests
        });

        // Find which learning interests match this user's skills (case-insensitive)
        const matchingInterests = learningInterests.filter(interest => {
          const normalizedInterest = String(interest).toLowerCase().trim();
          return skills.some(skill => String(skill).toLowerCase().trim() === normalizedInterest);
        });

        // If there's at least one matching skill, show this user as a recommendation
        if (matchingInterests.length > 0) {
          console.log(`✓ Match found! User ${data.name || docSnap.id} can teach:`, matchingInterests);
          found = true;

          const col = document.createElement("div");
          col.className = "col-md-4";

          // Find the display names of matching skills
          const matchingSkillsDisplay = matchingInterests.map(interest => {
            const index = skills.indexOf(interest);
            return index !== -1 && skillsDisplay[index] ? skillsDisplay[index] : interest;
          });

          const cardEl = document.createElement("div");
          cardEl.className = "card h-100 rec-card stimulate-in";
          cardEl.style.animationDelay = `${container.children.length * 0.1}s`;
          cardEl.innerHTML = `
            <div class="card-body">
              <h5 class="card-title mb-3">${data.name || (data.email || '').split('@')[0] || 'User'}</h5>
              <p class="mb-2">
                <strong class="text-success">✓ Matches your interest:</strong> ${matchingSkillsDisplay.join(", ")}
              </p>
              <p class="text-muted mb-3">
                <strong>Can Teach:</strong> ${skillsDisplay.length > 0 ? skillsDisplay.join(", ") : "Not specified"}
              </p>
              <a href="user.html?uid=${docSnap.id}" class="btn btn-outline-primary btn-sm w-100">
                View Profile
              </a>
            </div>
          `;
          col.appendChild(cardEl);
          container.appendChild(col);
        }
      });

      if (!found) {
        emptyState.classList.remove("d-none");
        emptyState.innerHTML = 'Oops! We couldn\'t find any matches for your current learning interests. Try <a href="dashboard.html">searching the dashboard</a> for other skills, or add different skills you\'d like to learn in your profile.';
        console.log("No matching users found. Check console for details.");
      } else {
        emptyState.classList.add("d-none");
        console.log("Recommendations displayed successfully!");
      }
    });
  </script>

  <script src="transitions.js"></script>
</body>

</html>